<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>记一次Vue附件上传组件踩坑记</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="上个礼拜刚刚结束一个Vue项目，这个项目分为移动端和桌面端，由于UI差异较大，分别建立了各自的Git仓库，公共代码部分通过Git Subtree共享。其中比较折腾的就是附件上传组件，这个组件有什么特点呢?  业务有大量附件要上传，包括图片和非图片，以及文件多选，图片类需要有预览 这个项目包括移动端和桌面端，希望能够复用非UI部分的代码 对于移动端，图片上传需要支持拍照上传，这对于iOS问题不大，可">
<meta name="keywords" content="vue,附件上传">
<meta property="og:type" content="article">
<meta property="og:title" content="记一次Vue附件上传组件踩坑记">
<meta property="og:url" content="http://cloudstone.space/2017/11/30/记一次Vue附件上传组件踩坑记/index.html">
<meta property="og:site_name" content="CloudStone">
<meta property="og:description" content="上个礼拜刚刚结束一个Vue项目，这个项目分为移动端和桌面端，由于UI差异较大，分别建立了各自的Git仓库，公共代码部分通过Git Subtree共享。其中比较折腾的就是附件上传组件，这个组件有什么特点呢?  业务有大量附件要上传，包括图片和非图片，以及文件多选，图片类需要有预览 这个项目包括移动端和桌面端，希望能够复用非UI部分的代码 对于移动端，图片上传需要支持拍照上传，这对于iOS问题不大，可">
<meta property="og:updated_time" content="2017-11-30T09:00:43.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="记一次Vue附件上传组件踩坑记">
<meta name="twitter:description" content="上个礼拜刚刚结束一个Vue项目，这个项目分为移动端和桌面端，由于UI差异较大，分别建立了各自的Git仓库，公共代码部分通过Git Subtree共享。其中比较折腾的就是附件上传组件，这个组件有什么特点呢?  业务有大量附件要上传，包括图片和非图片，以及文件多选，图片类需要有预览 这个项目包括移动端和桌面端，希望能够复用非UI部分的代码 对于移动端，图片上传需要支持拍照上传，这对于iOS问题不大，可">
  
    <link rel="alternative" href="/atom.xml" title="CloudStone" type="application/atom+xml">
  
  
    <link rel="icon" href="/images/favicon.ico">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner" >
		<a href="/" class="profilepic" style="display: block">
			
			<img lazy-src="http://en.gravatar.com/userimage/91074425/b7ac595a69ff4b9745e1931047ca4b7c.jpg?size=256" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">CloudStone</a></h1>
		</hgroup>

		
		<p class="header-subtitle">Tech Yard</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Menu</li>
						<li>Tags</li>
						
						
						<li>Über</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
							<li><a href="/about-me">About Me</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/stoneChen" title="github">github</a>
					        
								<a class="zhihu" target="_blank" href="https://www.zhihu.com/people/cloud-stone" title="zhihu">zhihu</a>
					        
								<a class="mail" target="_blank" href="/baby31529@gmail.com" title="mail">mail</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/DOCTYPE/" style="font-size: 10px;">DOCTYPE</a> <a href="/tags/IE/" style="font-size: 10px;">IE</a> <a href="/tags/Safari/" style="font-size: 10px;">Safari</a> <a href="/tags/angular/" style="font-size: 20px;">angular</a> <a href="/tags/angular-touch/" style="font-size: 10px;">angular-touch</a> <a href="/tags/animation/" style="font-size: 10px;">animation</a> <a href="/tags/backbone/" style="font-size: 10px;">backbone</a> <a href="/tags/chrome/" style="font-size: 18.89px;">chrome</a> <a href="/tags/chrome，调试/" style="font-size: 10px;">chrome，调试</a> <a href="/tags/commonjs/" style="font-size: 10px;">commonjs</a> <a href="/tags/csd/" style="font-size: 15.56px;">csd</a> <a href="/tags/css/" style="font-size: 11.11px;">css</a> <a href="/tags/css3/" style="font-size: 14.44px;">css3</a> <a href="/tags/disabled/" style="font-size: 10px;">disabled</a> <a href="/tags/emmet/" style="font-size: 10px;">emmet</a> <a href="/tags/es6/" style="font-size: 11.11px;">es6</a> <a href="/tags/essays/" style="font-size: 10px;">essays</a> <a href="/tags/finder/" style="font-size: 10px;">finder</a> <a href="/tags/ftp/" style="font-size: 10px;">ftp</a> <a href="/tags/generator/" style="font-size: 10px;">generator</a> <a href="/tags/git/" style="font-size: 11.11px;">git</a> <a href="/tags/grunt/" style="font-size: 14.44px;">grunt</a> <a href="/tags/hammer/" style="font-size: 10px;">hammer</a> <a href="/tags/html/" style="font-size: 12.22px;">html</a> <a href="/tags/http/" style="font-size: 10px;">http</a> <a href="/tags/iOS/" style="font-size: 12.22px;">iOS</a> <a href="/tags/javascript/" style="font-size: 13.33px;">javascript</a> <a href="/tags/koajs/" style="font-size: 10px;">koajs</a> <a href="/tags/less/" style="font-size: 10px;">less</a> <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/log/" style="font-size: 10px;">log</a> <a href="/tags/mac/" style="font-size: 11.11px;">mac</a> <a href="/tags/meta/" style="font-size: 10px;">meta</a> <a href="/tags/module-system/" style="font-size: 10px;">module system</a> <a href="/tags/node/" style="font-size: 11.11px;">node</a> <a href="/tags/nodejs/" style="font-size: 16.67px;">nodejs</a> <a href="/tags/nodejs-npm-cnpm/" style="font-size: 10px;">nodejs npm cnpm</a> <a href="/tags/npm/" style="font-size: 10px;">npm</a> <a href="/tags/os-x/" style="font-size: 14.44px;">os x</a> <a href="/tags/promise/" style="font-size: 10px;">promise</a> <a href="/tags/proxy/" style="font-size: 10px;">proxy</a> <a href="/tags/react/" style="font-size: 11.11px;">react</a> <a href="/tags/seajs/" style="font-size: 17.78px;">seajs</a> <a href="/tags/seajs-debug/" style="font-size: 10px;">seajs-debug</a> <a href="/tags/seo/" style="font-size: 11.11px;">seo</a> <a href="/tags/shadowsocks/" style="font-size: 11.11px;">shadowsocks</a> <a href="/tags/spm/" style="font-size: 12.22px;">spm</a> <a href="/tags/ssh/" style="font-size: 10px;">ssh</a> <a href="/tags/surge/" style="font-size: 10px;">surge</a> <a href="/tags/terminal/" style="font-size: 10px;">terminal</a> <a href="/tags/this/" style="font-size: 10px;">this</a> <a href="/tags/translate/" style="font-size: 11.11px;">translate</a> <a href="/tags/ts/" style="font-size: 10px;">ts</a> <a href="/tags/typescript/" style="font-size: 10px;">typescript</a> <a href="/tags/ubuntu/" style="font-size: 10px;">ubuntu</a> <a href="/tags/ueditor/" style="font-size: 10px;">ueditor</a> <a href="/tags/vpn/" style="font-size: 10px;">vpn</a> <a href="/tags/vscode/" style="font-size: 10px;">vscode</a> <a href="/tags/vue/" style="font-size: 10px;">vue</a> <a href="/tags/web/" style="font-size: 10px;">web</a> <a href="/tags/webpack/" style="font-size: 11.11px;">webpack</a> <a href="/tags/webstorm/" style="font-size: 10px;">webstorm</a> <a href="/tags/weinre/" style="font-size: 10px;">weinre</a> <a href="/tags/yaml/" style="font-size: 10px;">yaml</a> <a href="/tags/yeoman/" style="font-size: 11.11px;">yeoman</a> <a href="/tags/yo/" style="font-size: 11.11px;">yo</a> <a href="/tags/分享/" style="font-size: 10px;">分享</a> <a href="/tags/前后端分离/" style="font-size: 10px;">前后端分离</a> <a href="/tags/在线IDE/" style="font-size: 10px;">在线IDE</a> <a href="/tags/定位/" style="font-size: 10px;">定位</a> <a href="/tags/工具/" style="font-size: 10px;">工具</a> <a href="/tags/微信/" style="font-size: 10px;">微信</a> <a href="/tags/性能/" style="font-size: 10px;">性能</a> <a href="/tags/断点调试/" style="font-size: 10px;">断点调试</a> <a href="/tags/百分比/" style="font-size: 10px;">百分比</a> <a href="/tags/移动端/" style="font-size: 14.44px;">移动端</a> <a href="/tags/继承/" style="font-size: 10px;">继承</a> <a href="/tags/翻墙/" style="font-size: 11.11px;">翻墙</a> <a href="/tags/联调/" style="font-size: 10px;">联调</a> <a href="/tags/调试/" style="font-size: 18.89px;">调试</a> <a href="/tags/转盘/" style="font-size: 10px;">转盘</a> <a href="/tags/远程开发/" style="font-size: 10px;">远程开发</a> <a href="/tags/附件上传/" style="font-size: 10px;">附件上传</a> <a href="/tags/雪碧图/" style="font-size: 10px;">雪碧图</a> <a href="/tags/面试/" style="font-size: 10px;">面试</a>
					</div>
				</section>
				
				
				

				
				
				<section class="switch-part switch-part3">
				
					<div id="js-aboutme">我是谁，我从哪里来，我到哪里去？我就是我，是颜色不一样的吃货…</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">CloudStone</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img lazy-src="http://en.gravatar.com/userimage/91074425/b7ac595a69ff4b9745e1931047ca4b7c.jpg?size=256" class="js-avatar">
			
			</div>
			<hgroup>
			  <h1 class="header-author">CloudStone</h1>
			</hgroup>
			
			<p class="header-subtitle">Tech Yard</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
					<li><a href="/about-me">About Me</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/stoneChen" title="github">github</a>
			        
						<a class="zhihu" target="_blank" href="https://www.zhihu.com/people/cloud-stone" title="zhihu">zhihu</a>
			        
						<a class="mail" target="_blank" href="/baby31529@gmail.com" title="mail">mail</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap"><article id="post-记一次Vue附件上传组件踩坑记" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/11/30/记一次Vue附件上传组件踩坑记/" class="article-date">
  	<time datetime="2017-11-30T01:13:11.000Z" itemprop="datePublished">2017-11-30</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      记一次Vue附件上传组件踩坑记
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/vue/">vue</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/附件上传/">附件上传</a></li></ul>
	</div>

        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>上个礼拜刚刚结束一个Vue项目，这个项目分为移动端和桌面端，由于UI差异较大，分别建立了各自的Git仓库，公共代码部分通过Git Subtree共享。其中比较折腾的就是附件上传组件，这个组件有什么特点呢?</p>
<ol>
<li>业务有大量附件要上传，包括图片和非图片，以及文件多选，图片类需要有预览</li>
<li>这个项目包括移动端和桌面端，希望能够复用非UI部分的代码</li>
<li>对于移动端，图片上传需要支持拍照上传，这对于iOS问题不大，可是安卓就坑了。</li>
<li>尤其移动端上的图片，一般都是手机拍照图片，像素可谓不小，需要进行压缩再上传，以加快上传速度、减少带宽占用</li>
</ol>
<a id="more"></a>
<p>其中：PC端依赖了饿了么组件库<a href="https://github.com/ElemeFE/element" target="_blank" rel="external">element-ui</a>, 移动端依赖了饿了么移动端组件库<a href="https://github.com/ElemeFE/mint-ui" target="_blank" rel="external">mint-ui</a>。附件上传的服务端接口已经通过Nodejs实现，基于<a href="https://github.com/koajs/koa" target="_blank" rel="external">Koa</a>和<a href="https://github.com/mscdex/busboy" target="_blank" rel="external">busboy</a>。虽然<code>element-ui</code>已经提供了附件上传功能，但是在文件个数方面的检查没有暴露出足够的钩子来处理，最终决定还是自己写，其实并没有很复杂。</p>
<p>对于第1点，对于上传本身来说并没有什么区别，只是需要对上传结果进行分别处理, 另外需要提供文件个数限制的prop。</p>
<p>对于第2点，由于两个端的UI差异，移动端和桌面端需要作为两个独立组件存在，组件模板以及样式分别处理，于是我们可以把组件的<code>props</code>,<code>data</code>,<code>computed</code>,<code>methods</code>等选项都抽出来作为<code>mixin</code> 放置在Git Subtree，两个组件都引入这个<code>mixin</code>。</p>
<p>对于第3点，国内各大安卓手机厂商似乎对浏览器的附件方面支持不统一，附件选择原生样式方面就不说了，连功能也不统一。单文件上传还好，多文件（即<code>&lt;input type=&quot;file&quot; multiple&gt;</code>）有一些手机就不支持拍照上传了，尤其是今年来很火热的华为手机最让人费解，这么优秀的厂商，对浏览器的附件上传拍照功能支持居然不友好。google了一番后，发现结合<code>capture</code>这个属性可以解决一部分问题，而且只是基于微信的webview，很多安卓手机自带浏览器仍然有问题。如果希望比较完美的话，估计还得是放弃支持安卓自带浏览器，然后调用微信jssdk接口，最终通过原生的方式调用摄像头拍照上传。</p>
<p>对于第4点，同事之前写了一个图片压缩的库，很赞！但有一个问题，传给压缩库的是File对象，返回的却是Blob对象，如果在append到formData时，未指定文件名，那么服务端拿到的文件名将是<code>blob</code>,参考<a href="https://developer.mozilla.org/en-US/docs/Web/API/FormData/append" target="_blank" rel="external">MDN文档</a>，解决办法是从原始File对象读取文件名，传给第三个参数。</p>
<p>以下为最终组件源码<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// common-sdk/components/file-uploader/mixin.js  common-sdk可通过webpack设置别名</span></div><div class="line"><span class="comment">// 我司出品的图片压缩库</span></div><div class="line"><span class="keyword">import</span> ImageCompressor <span class="keyword">from</span> <span class="string">'@xkeshi/image-compressor'</span></div><div class="line"></div><div class="line"><span class="keyword">const</span> FILE_TYPES = [</div><div class="line">  <span class="string">'image/jpg'</span>,</div><div class="line">  <span class="string">'image/jpeg'</span>,</div><div class="line">  <span class="string">'image/png'</span>,</div><div class="line">  <span class="comment">// gif被压缩后，就不会动了。。。不压缩gif</span></div><div class="line">]</div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</div><div class="line">  props: &#123;</div><div class="line">    value: &#123;</div><div class="line">      type: [<span class="built_in">Array</span>, <span class="built_in">String</span>],</div><div class="line">    &#125;,</div><div class="line">    <span class="comment">// 文件个数限制</span></div><div class="line">    fileQuantityLimit: &#123;</div><div class="line">      type: <span class="built_in">Number</span>,</div><div class="line">      <span class="keyword">default</span>: <span class="number">5</span>,</div><div class="line">    &#125;,</div><div class="line">    <span class="comment">// 文件大小限制</span></div><div class="line">    fileSizeLimit: &#123;</div><div class="line">      type: <span class="built_in">Number</span>,</div><div class="line">      <span class="keyword">default</span>: <span class="number">10</span>,</div><div class="line">    &#125;,</div><div class="line">    <span class="comment">// 是否为图片上传，如果是，将提供图片预览</span></div><div class="line">    isPicture: &#123;</div><div class="line">      type: <span class="built_in">Boolean</span>,</div><div class="line">      <span class="keyword">default</span>: <span class="literal">true</span>,</div><div class="line">    &#125;,</div><div class="line">  &#125;,</div><div class="line">  computed: &#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 是否显示文件选择器</span></div><div class="line"><span class="comment">     * @return &#123;boolean&#125; *</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    isShowSelector() &#123;</div><div class="line">      <span class="comment">// 上传中不显示</span></div><div class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.isUploading) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span></div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.fileQuantityLimit === <span class="number">1</span>) &#123;</div><div class="line">        <span class="keyword">return</span> !<span class="keyword">this</span>.value</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.fileQuantityLimit - (<span class="keyword">this</span>.value || []).length &gt; <span class="number">0</span></div><div class="line">    &#125;,</div><div class="line">  &#125;,</div><div class="line">  data() &#123;</div><div class="line">    <span class="keyword">return</span> &#123;</div><div class="line">      <span class="comment">// 对于图片上传，理论上最好把具体的图片类型列举出来，但是移动端的图片上传只能写成image/*</span></div><div class="line">      accept: <span class="keyword">this</span>.isPicture ? <span class="string">'image/*'</span> : <span class="string">''</span>,</div><div class="line">      isUploading: <span class="literal">false</span>,</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  methods: &#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 单图片上传时的删除事件</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    removeSinglePicture() &#123;</div><div class="line">      <span class="keyword">this</span>.$emit(<span class="string">'input'</span>, <span class="literal">null</span>)</div><div class="line">    &#125;,</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 多图上传时的删除事件</span></div><div class="line"><span class="comment">     * @param &#123;number&#125; removeIndex - 待删除的图片下标</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    removeMultipleImage(removeIndex) &#123;</div><div class="line">      <span class="keyword">this</span>.$emit(<span class="string">'input'</span>, <span class="keyword">this</span>.value.filter(<span class="function">(<span class="params">file, index</span>) =&gt;</span> &#123;</div><div class="line">        <span class="keyword">return</span> removeIndex !== index</div><div class="line">      &#125;))</div><div class="line">    &#125;,</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 多文件上传时的删除操作</span></div><div class="line"><span class="comment">     * @param &#123;number&#125; removeIndex - 待删除的图片下标</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    removeAttachment(removeIndex) &#123;</div><div class="line">      <span class="keyword">this</span>.$emit(<span class="string">'input'</span>, <span class="keyword">this</span>.value.filter(<span class="function">(<span class="params">file, index</span>) =&gt;</span> &#123;</div><div class="line">        <span class="keyword">return</span> removeIndex !== index</div><div class="line">      &#125;))</div><div class="line">    &#125;,</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 文件触发器的点击事件</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    onClickTrigger() &#123;</div><div class="line">      <span class="keyword">this</span>.$refs.file.click()</div><div class="line">    &#125;,</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 文件改变事件</span></div><div class="line"><span class="comment">     * @param &#123;Event&#125; e - 文件事件对象</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    onFileChange(e) &#123;</div><div class="line">      <span class="keyword">const</span> fileList = [].slice.apply(e.target.files)</div><div class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.fileQuantityLimit &gt; <span class="number">1</span> &amp;&amp;</div><div class="line">        fileList.length - (<span class="keyword">this</span>.fileQuantityLimit - <span class="keyword">this</span>.value.length) &gt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="comment">// showError方法由各自实现，因为UI不一致</span></div><div class="line">        <span class="keyword">this</span>.showError(<span class="string">`最多可上传<span class="subst">$&#123;<span class="keyword">this</span>.fileQuantityLimit&#125;</span>个文件`</span>)</div><div class="line">        <span class="keyword">return</span></div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.isPicture) &#123;</div><div class="line">        <span class="keyword">const</span> isFilesTypeValid = fileList.every(<span class="function">(<span class="params">file</span>) =&gt;</span> &#123;</div><div class="line">          <span class="keyword">const</span> isValid = <span class="regexp">/\.(jpe?g|png|gif)$/i</span>.test(file.name)</div><div class="line">          <span class="keyword">if</span> (!isValid) &#123;</div><div class="line">            <span class="keyword">this</span>.showError(<span class="string">`请选择jpg、jpeg、png、gif格式的图片, '<span class="subst">$&#123;file.name&#125;</span>' 不符合要求`</span>)</div><div class="line">          &#125;</div><div class="line">          <span class="keyword">return</span> isValid</div><div class="line">        &#125;)</div><div class="line">        <span class="keyword">if</span> (!isFilesTypeValid) &#123;</div><div class="line">          <span class="keyword">return</span></div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">const</span> isFilesSizeValid = fileList.every(<span class="function">(<span class="params">file</span>) =&gt;</span> &#123;</div><div class="line">        <span class="keyword">const</span> isValid = file.size &lt;= (<span class="keyword">this</span>.fileSizeLimit * <span class="number">1024</span> * <span class="number">1024</span>)</div><div class="line">        <span class="keyword">if</span> (!isValid) &#123;</div><div class="line">          <span class="keyword">this</span>.showError(<span class="string">`文件尺寸不得超过<span class="subst">$&#123;<span class="keyword">this</span>.fileSizeLimit&#125;</span>M, '<span class="subst">$&#123;file.name&#125;</span>' 不符合要求`</span>)</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> isValid</div><div class="line">      &#125;)</div><div class="line">      <span class="keyword">if</span> (!isFilesSizeValid) &#123;</div><div class="line">        <span class="keyword">return</span></div><div class="line">      &#125;</div><div class="line">      <span class="keyword">this</span>.isUploading = <span class="literal">true</span></div><div class="line">      <span class="comment">// 清空文件, 否则上传与上次一样的文件，不会触发change事件</span></div><div class="line">      <span class="keyword">this</span>.$refs.file.value = <span class="literal">null</span></div><div class="line">      <span class="built_in">Promise</span>.all(fileList.map(<span class="function">(<span class="params">file</span>) =&gt;</span> &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.upload(file)</div><div class="line">      &#125;))</div><div class="line">        .then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">          <span class="keyword">this</span>.isUploading = <span class="literal">false</span></div><div class="line">        &#125;)</div><div class="line">        .catch(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</div><div class="line">          <span class="keyword">this</span>.isUploading = <span class="literal">false</span></div><div class="line">          <span class="keyword">this</span>.showError(<span class="string">'上传出错'</span>)</div><div class="line">          <span class="keyword">this</span>.error(error)</div><div class="line">        &#125;)</div><div class="line">    &#125;,</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 上传操作</span></div><div class="line"><span class="comment">     * @param &#123;File&#125; file - 文件对象</span></div><div class="line"><span class="comment">     * @return &#123;Promise&#125; *</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    upload(file) &#123;</div><div class="line">      <span class="keyword">this</span>.log(<span class="string">'File before compression:'</span>, file)</div><div class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.compress(file)</div><div class="line">        .then(<span class="function">(<span class="params">compressedFile</span>) =&gt;</span> &#123;</div><div class="line">          <span class="keyword">const</span> formData = <span class="keyword">new</span> FormData()</div><div class="line">          <span class="comment">// 第三个参数是必要的，根据MDN文档，如果第二个参数是Blob类型，那么传递给服务器的文件名将是"blob"</span></div><div class="line">          <span class="comment">// 第三个参数用于设置传递给服务器的文件名</span></div><div class="line">          formData.append(<span class="string">'upfile'</span>, compressedFile, compressedFile.name)</div><div class="line">          <span class="keyword">return</span> <span class="keyword">this</span>.http.post(<span class="string">'/upload'</span>, formData)</div><div class="line">        &#125;)</div><div class="line">        .then(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</div><div class="line">          <span class="keyword">const</span> originalName = file.name</div><div class="line">          <span class="keyword">const</span> &#123;</div><div class="line">            url,</div><div class="line">          &#125; = res.result</div><div class="line">          <span class="keyword">if</span> (<span class="keyword">this</span>.isPicture &amp;&amp; <span class="keyword">this</span>.fileQuantityLimit === <span class="number">1</span>) &#123;</div><div class="line">            <span class="keyword">this</span>.$emit(<span class="string">'input'</span>, url)</div><div class="line">          &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">this</span>.value.push(&#123;</div><div class="line">              name: originalName,</div><div class="line">              url,</div><div class="line">            &#125;)</div><div class="line">          &#125;</div><div class="line">        &#125;)</div><div class="line">    &#125;,</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 压缩图片</span></div><div class="line"><span class="comment">     * @param &#123;File&#125; file - 待压缩的file对象</span></div><div class="line"><span class="comment">     * @return &#123;Promise&#125; *</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    compress(file) &#123;</div><div class="line">      <span class="keyword">if</span> (FILE_TYPES.indexOf(file.type) === <span class="number">-1</span>) &#123;</div><div class="line">        <span class="keyword">this</span>.log(<span class="string">'File type is not supported to be compressed, skipped.'</span>)</div><div class="line">        <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve(file)</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</div><div class="line">        <span class="keyword">this</span>.log(<span class="string">`File type is '<span class="subst">$&#123;file.type&#125;</span>', start compressing...`</span>)</div><div class="line">        <span class="keyword">new</span> ImageCompressor(file, &#123;</div><div class="line">          quality: <span class="number">0.2</span>,</div><div class="line">          maxWidth: <span class="number">2560</span>,</div><div class="line">          maxHeight: <span class="number">2560</span>,</div><div class="line">          <span class="comment">// eslint-disable-next-line</span></div><div class="line">          success: <span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</div><div class="line">            <span class="keyword">this</span>.log(<span class="string">'Compressed file:'</span>, result)</div><div class="line">            <span class="keyword">const</span> originalSize = <span class="built_in">Math</span>.round(file.size / <span class="number">1024</span>)</div><div class="line">            <span class="keyword">const</span> compressedSize = <span class="built_in">Math</span>.round(result.size / <span class="number">1024</span>)</div><div class="line">            <span class="keyword">const</span> rate = ((<span class="number">1</span> - (compressedSize / originalSize)) * <span class="number">100</span>).toFixed(<span class="number">2</span>)</div><div class="line">            <span class="keyword">this</span>.log(<span class="string">`File compression for '<span class="subst">$&#123;result.name&#125;</span>': <span class="subst">$&#123;originalSize&#125;</span>K =&gt; <span class="subst">$&#123;compressedSize&#125;</span>K(<span class="subst">$&#123;rate&#125;</span>% off)`</span>)</div><div class="line">            resolve(result)</div><div class="line">          &#125;,</div><div class="line">          <span class="comment">// eslint-disable-next-line</span></div><div class="line">          error: <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</div><div class="line">            reject(e)</div><div class="line">          &#125;,</div><div class="line">        &#125;)</div><div class="line">      &#125;)</div><div class="line">    &#125;,</div><div class="line">  &#125;,</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 移动端上传组件，已省略样式部分 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"file-uploader-wrapper"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-if</span>=<span class="string">"value &amp;&amp; isPicture &amp;&amp; fileQuantityLimit === 1"</span> <span class="attr">class</span>=<span class="string">"closable-wrapper"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">fa-icon</span> <span class="attr">name</span>=<span class="string">"times-circle"</span> @<span class="attr">click.native</span>=<span class="string">"removeSinglePicture"</span>&gt;</span><span class="tag">&lt;/<span class="name">fa-icon</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">image-preview</span> <span class="attr">:src</span>=<span class="string">"value"</span>&gt;</span><span class="tag">&lt;/<span class="name">image-preview</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">template</span> <span class="attr">v-if</span>=<span class="string">"value &amp;&amp; isPicture &amp;&amp; fileQuantityLimit &gt; 1"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-for</span>=<span class="string">"(img, index) in value"</span> <span class="attr">:key</span>=<span class="string">"index"</span> <span class="attr">class</span>=<span class="string">"closable-wrapper"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">fa-icon</span> <span class="attr">name</span>=<span class="string">"times-circle"</span> @<span class="attr">click.native</span>=<span class="string">"removeMultipleImage(index)"</span>&gt;</span><span class="tag">&lt;/<span class="name">fa-icon</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">image-preview</span> <span class="attr">:src</span>=<span class="string">"img.url"</span>&gt;</span><span class="tag">&lt;/<span class="name">image-preview</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">template</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">v-if</span>=<span class="string">"!isPicture"</span> <span class="attr">class</span>=<span class="string">"attachments-wrapper"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">li</span> <span class="attr">v-for</span>=<span class="string">"(item, index) in value"</span></span></div><div class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">"closable-wrapper attachments-file-wrapper"</span></span></div><div class="line"><span class="tag">          <span class="attr">:key</span>=<span class="string">"index"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">fa-icon</span> <span class="attr">name</span>=<span class="string">"times-circle"</span> @<span class="attr">click.native</span>=<span class="string">"removeAttachment(index)"</span>&gt;</span><span class="tag">&lt;/<span class="name">fa-icon</span>&gt;</span></div><div class="line">        &#123;&#123;item.name | middleEllipsisText&#125;&#125;</div><div class="line">      <span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span></span></div><div class="line"><span class="tag">           <span class="attr">:accept</span>=<span class="string">"accept"</span></span></div><div class="line"><span class="tag">           <span class="attr">:multiple</span>=<span class="string">"fileQuantityLimit &gt; 1"</span></span></div><div class="line"><span class="tag">           <span class="attr">ref</span>=<span class="string">"file"</span></span></div><div class="line"><span class="tag">           @<span class="attr">change</span>=<span class="string">"onFileChange"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"file-uploader__cover"</span> <span class="attr">v-show</span>=<span class="string">"isShowSelector"</span> @<span class="attr">click</span>=<span class="string">"onClickTrigger"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"file-uploader__icon"</span> <span class="attr">:class</span>=<span class="string">"&#123; 'upload-file': !isPicture &#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"loading"</span> <span class="attr">v-show</span>=<span class="string">"isUploading"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">mt-spinner</span> <span class="attr">type</span>=<span class="string">"snake"</span>&gt;</span><span class="tag">&lt;/<span class="name">mt-spinner</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/babel"</span>&gt;</span><span class="undefined"></span></div><div class="line"><span class="javascript">  <span class="keyword">import</span> fileUploadMixin <span class="keyword">from</span> <span class="string">'common-sdk/components/file-uploader/mixin'</span></span></div><div class="line"><span class="undefined"></span></div><div class="line"><span class="javascript">  <span class="keyword">const</span> isIOS = <span class="regexp">/iphone|ipad|ipod/i</span>.test(global.navigator.userAgent)</span></div><div class="line"><span class="undefined"></span></div><div class="line"><span class="javascript">  <span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></div><div class="line"><span class="undefined">    mixins: [fileUploadMixin],</span></div><div class="line"><span class="undefined">    props: &#123;</span></div><div class="line"><span class="undefined">      tip: &#123;</span></div><div class="line"><span class="javascript">        type: <span class="built_in">String</span>,</span></div><div class="line"><span class="javascript">        <span class="keyword">default</span>: <span class="string">'最多上传5个，单个文件大小在10M以内'</span>,</span></div><div class="line"><span class="undefined">      &#125;,</span></div><div class="line"><span class="undefined">    &#125;,</span></div><div class="line"><span class="undefined">    mounted() &#123;</span></div><div class="line"><span class="javascript">      <span class="comment">// 根据是否多图设置captrue属性，否则有些手机无法拍照上传，比如华为</span></span></div><div class="line"><span class="javascript">      <span class="keyword">const</span> $file = <span class="keyword">this</span>.$refs.file</span></div><div class="line"><span class="javascript">      <span class="keyword">if</span> (<span class="keyword">this</span>.fileQuantityLimit === <span class="number">1</span> || isIOS) &#123;</span></div><div class="line"><span class="javascript">        <span class="keyword">return</span></span></div><div class="line"><span class="undefined">      &#125;</span></div><div class="line"><span class="javascript">      $file.setAttribute(<span class="string">'capture'</span>, <span class="string">'camera'</span>)</span></div><div class="line"><span class="undefined">    &#125;,</span></div><div class="line"><span class="undefined">    methods: &#123;</span></div><div class="line"><span class="undefined">      /**</span></div><div class="line"><span class="undefined">       * 显示错误消息</span></div><div class="line"><span class="undefined">       * @param &#123;string&#125; message - 错误信息</span></div><div class="line"><span class="undefined">       */</span></div><div class="line"><span class="undefined">      showError(message) &#123;</span></div><div class="line"><span class="javascript">        <span class="keyword">this</span>.$toast(message)</span></div><div class="line"><span class="undefined">      &#125;,</span></div><div class="line"><span class="undefined">    &#125;,</span></div><div class="line"><span class="undefined">  &#125;</span></div><div class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 桌面端上传组件，已忽略样式部分 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"file-uploader"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span></span></div><div class="line"><span class="tag">           <span class="attr">:multiple</span>=<span class="string">"fileQuantityLimit &gt; 1"</span></span></div><div class="line"><span class="tag">           <span class="attr">:accept</span>=<span class="string">"accept"</span></span></div><div class="line"><span class="tag">           <span class="attr">ref</span>=<span class="string">"file"</span></span></div><div class="line"><span class="tag">           @<span class="attr">change</span>=<span class="string">"onFileChange"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">:disabled</span>=<span class="string">"!isShowSelector"</span> @<span class="attr">click</span>=<span class="string">"onClickTrigger"</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"el-icon-plus"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></div><div class="line">      上传&#123;&#123; isPicture ? '图片' : ''&#125;&#125;<span class="tag">&lt;/<span class="name">button</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"loading"</span> <span class="attr">v-show</span>=<span class="string">"isUploading"</span>&gt;</span>正在上传...<span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"file-uploader__tip"</span>&gt;</span>&#123;&#123;tip&#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-if</span>=<span class="string">"value &amp;&amp; isPicture &amp;&amp; fileQuantityLimit === 1"</span> <span class="attr">class</span>=<span class="string">"closable-wrapper"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"el-icon-circle-cross"</span> @<span class="attr">click</span>=<span class="string">"removeSinglePicture"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">image-view-lg</span> <span class="attr">v-model</span>=<span class="string">"value"</span>&gt;</span><span class="tag">&lt;/<span class="name">image-view-lg</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">v-if</span>=<span class="string">"value &amp;&amp; isPicture &amp;&amp; fileQuantityLimit &gt; 1"</span> <span class="attr">class</span>=<span class="string">"img-wrapper"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">li</span> <span class="attr">v-for</span>=<span class="string">"(img, index) in value"</span> <span class="attr">:key</span>=<span class="string">"index"</span> <span class="attr">class</span>=<span class="string">"closable-wrapper"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"el-icon-circle-cross"</span> @<span class="attr">click</span>=<span class="string">"removeMultipleImage(index)"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">image-view-lg</span> <span class="attr">v-model</span>=<span class="string">"img.url"</span> <span class="attr">class</span>=<span class="string">"avatar"</span>&gt;</span><span class="tag">&lt;/<span class="name">image-view-lg</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">v-if</span>=<span class="string">"!isPicture"</span> <span class="attr">class</span>=<span class="string">"attachments-wrapper"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">li</span> <span class="attr">v-for</span>=<span class="string">"(item, index) in value"</span></span></div><div class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">"closable-wrapper attachments-file-wrapper"</span></span></div><div class="line"><span class="tag">          <span class="attr">:key</span>=<span class="string">"index"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"el-icon-circle-cross"</span> @<span class="attr">click</span>=<span class="string">"removeAttachment(index)"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">:href</span>=<span class="string">"item.url"</span> <span class="attr">target</span>=<span class="string">"_blank"</span>&gt;</span></div><div class="line">          &#123;&#123;item.name&#125;&#125;</div><div class="line">        <span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></div><div class="line"><span class="javascript">  <span class="keyword">import</span> fileUploadMixin <span class="keyword">from</span> <span class="string">'common-sdk/components/file-uploader/mixin'</span></span></div><div class="line"><span class="undefined"></span></div><div class="line"><span class="javascript">  <span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></div><div class="line"><span class="undefined">    mixins: [fileUploadMixin],</span></div><div class="line"><span class="undefined">    props: &#123;</span></div><div class="line"><span class="undefined">      tip: &#123;</span></div><div class="line"><span class="javascript">        type: <span class="built_in">String</span>,</span></div><div class="line"><span class="javascript">        <span class="keyword">default</span>: <span class="string">'支持JPG、PNG、GIF、JPEG格式'</span>,</span></div><div class="line"><span class="undefined">      &#125;,</span></div><div class="line"><span class="undefined">    &#125;,</span></div><div class="line"><span class="undefined">    data() &#123;</span></div><div class="line"><span class="javascript">      <span class="keyword">return</span> &#123;</span></div><div class="line"><span class="javascript">        <span class="comment">// PC端用image/*会很慢</span></span></div><div class="line"><span class="javascript">        accept: <span class="keyword">this</span>.isPicture ? <span class="string">'image/jpg,image/jpeg,image/png,image/gif'</span> : <span class="string">''</span>,</span></div><div class="line"><span class="undefined">      &#125;</span></div><div class="line"><span class="undefined">    &#125;,</span></div><div class="line"><span class="undefined">    methods: &#123;</span></div><div class="line"><span class="undefined">      /**</span></div><div class="line"><span class="undefined">       * 显示错误消息</span></div><div class="line"><span class="undefined">       * @param &#123;string&#125; message - 错误信息</span></div><div class="line"><span class="undefined">       */</span></div><div class="line"><span class="undefined">      showError(message) &#123;</span></div><div class="line"><span class="javascript">        <span class="keyword">this</span>.$alert(message)</span></div><div class="line"><span class="undefined">      &#125;,</span></div><div class="line"><span class="undefined">    &#125;,</span></div><div class="line"><span class="undefined">  &#125;</span></div><div class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div></pre></td></tr></table></figure>
<p>欢迎交流。</p>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/12/26/Node-js之terminal彩色字体/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          Node.js之terminal彩色字体
        
      </div>
    </a>
  
  
    <a href="/2017/10/22/使用vscode断点调试typescript/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">使用vscode一键断点调试typescript</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>


<div class="share_jia">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">Share to: &nbsp; </span>
		<a class="jiathis_button_facebook"></a> 
    <a class="jiathis_button_twitter"></a>
    <a class="jiathis_button_plus"></a> 
    <a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>






<div class="duoshuo">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="记一次Vue附件上传组件踩坑记" data-title="记一次Vue附件上传组件踩坑记" data-url="http://cloudstone.space/2017/11/30/记一次Vue附件上传组件踩坑记/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"cloudstone"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>




</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2018 CloudStone
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: true
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>



<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-74090133-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->




<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>